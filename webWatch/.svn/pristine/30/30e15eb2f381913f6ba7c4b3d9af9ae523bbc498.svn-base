package com.watch.controller;

import ch.qos.logback.classic.Logger;
import com.watch.bean.*;
import com.watch.common.Constants;
import com.watch.common.Methods;
import com.watch.common.bean.ControllerResult;
import com.watch.common.bean.Pager4EasyUI;
import com.watch.service.ShoseService;
import org.apache.ibatis.annotations.Param;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import javax.annotation.Resource;
import java.io.File;
import java.io.IOException;

/**
 * Created by xiao-kang on 2017/4/11.
 */
@Controller
@RequestMapping("/shose")
public class ShoseController {

    private Logger logger = (Logger) LoggerFactory.getLogger(ShoseController.class);

    @Resource
    private ShoseService shoseService;

    /**
     * 鞋子管理页面*/
    @RequestMapping(value = "shose_page",method = RequestMethod.GET)
    public String showshose(Model model) {
        return "/admin-page/shose-page";
    }

    @ResponseBody
    @RequestMapping(value="query_pager",method=RequestMethod.GET)
    public Pager4EasyUI<Shose> queryPager(@Param("page")String page, @Param("rows")String rows, @Param("brand") String brand, @Param("title") String title){
        logger.info("分页查询所有鞋子");
        Pager4EasyUI<Shose> pager = new Pager4EasyUI<Shose>();
        pager.setPageNo(Integer.valueOf(page));
        pager.setPageSize(Integer.valueOf(rows));
        Shose shose = new Shose();
        if(title != null && !title.equals("") || brand != null && !brand.equals("")){
            shose.setTitle(title);
            shose.setBrandId(Integer.valueOf(brand));
        }
        pager = shoseService.queryByPagerAndCriteria(pager,shose);
        return pager;
    }


    @ResponseBody
    @RequestMapping(value="add_shose",method = RequestMethod.POST)
    public ControllerResult addshose(MultipartFile videofile, Shose shose, @RequestParam MultipartFile[] files){
        logger.info("添加鞋子");
        try {
            for(int i = 0, len =  files.length; i < len;i++){
                MultipartFile file = files[i];
                String fileName = Methods.createName(file.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                if(!file.isEmpty()){
                    file.transferTo(new File(path));
                    if(i == 0){
                        shose.setImage(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 1){
                        shose.setImage1(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 2){
                        shose.setImage2(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 3){
                        shose.setImage3(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 4){
                        shose.setImage4(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 5){
                        shose.setImage5(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 6){
                        shose.setImage6(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 7){
                        shose.setImage7(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }else if(i == 8){
                        shose.setImage8(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
                    }
                }
            }
            if(videofile != null){
                String fileName = Methods.createName(videofile.getOriginalFilename());
                String path = Methods.uploadPath("video") + fileName;
                if(!videofile.isEmpty()){
                    videofile.transferTo(new File(path));
                    shose.setVideo(Constants.UPLOAD_VIDEO + Methods.createNewFolder() + "/" + fileName);
                }
            }
        }catch (IOException e){

        }
        getComboxId(shose);
        shoseService.add(shose);
        return ControllerResult.getSuccessResult("添加成功");
    }

    @ResponseBody
    @RequestMapping(value="update_shose",method = RequestMethod.POST)
    public ControllerResult updateshose(Shose shose,MultipartFile videofile,String video){
        logger.info("更新鞋子基本信息");
        try {
            if(videofile != null){
                String fileName = Methods.createName(videofile.getOriginalFilename());
                String path = Methods.uploadPath("video") + fileName;
                if(!videofile.isEmpty()){
                    videofile.transferTo(new File(path));
                    shose.setVideo(Constants.UPLOAD_VIDEO + Methods.createNewFolder() + "/" + fileName);
                }
            }else{
                shose.setVideo(video);
            }

        }catch (IOException e){

        }
        getComboxId(shose);
        shoseService.update(shose);
        return ControllerResult.getSuccessResult("更新成功");
    }

    @ResponseBody
    @RequestMapping(value="update_shoseImg",method = RequestMethod.POST)
    public ControllerResult updateWatchImg(Shose shose,MultipartFile file1,MultipartFile file2,MultipartFile file3,
                                           MultipartFile file4,MultipartFile file5,MultipartFile file6,MultipartFile file7,
                                           MultipartFile file8,MultipartFile file9){
        logger.info("更新鞋子图片");
        try {
            Shose shose1 = shoseService.queryById(shose.getId());
            if(file1 != null){
                String fileName = Methods.createName(file1.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file1.transferTo(new File(path));
                shose.setImage(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage(shose1.getImage());
            }
            if(file2 != null){
                String fileName = Methods.createName(file2.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file2.transferTo(new File(path));
                shose.setImage1(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage1(shose1.getImage1());
            }
            if(file3 != null){
                String fileName = Methods.createName(file3.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file3.transferTo(new File(path));
                shose.setImage2(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage2(shose1.getImage2());
            }

            if(file4 != null){
                String fileName = Methods.createName(file4.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file4.transferTo(new File(path));
                shose.setImage3(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage3(shose1.getImage3());
            }

            if(file5 != null){
                String fileName = Methods.createName(file5.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file5.transferTo(new File(path));
                shose.setImage4(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage4(shose1.getImage4());
            }

            if(file6 != null){
                String fileName = Methods.createName(file6.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file6.transferTo(new File(path));
                shose.setImage5(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage5(shose1.getImage5());
            }

            if(file7 != null){
                String fileName = Methods.createName(file7.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file7.transferTo(new File(path));
                shose.setImage6(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage6(shose1.getImage6());
            }
            if(file8 != null){
                String fileName = Methods.createName(file8.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file8.transferTo(new File(path));
                shose.setImage7(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage7(shose1.getImage7());
            }
            if(file9 != null){
                String fileName = Methods.createName(file9.getOriginalFilename());
                String path = Methods.uploadPath("img") + fileName;
                file9.transferTo(new File(path));
                shose.setImage8(Constants.UPLOAD_IMAGES + Methods.createNewFolder() + "/" + fileName);
            }else{
                shose.setImage8(shose1.getImage8());
            }

        }catch (IOException e){

        }
        shoseService.updateImg(shose);
        return ControllerResult.getSuccessResult("更新成功");
    }



    @ResponseBody
    @RequestMapping(value="deleteById",method = RequestMethod.GET)
    public ControllerResult deleteById(@Param("ids") String ids){
        logger.info("删除手表");
        shoseService.deleteByIds(ids);
        return ControllerResult.getSuccessResult("删除成功");
    }

    /*
  * 根据页面的comboxID设置到
  * */
    public void getComboxId(Shose shose){
        Material material = new Material();
        material.setId(shose.getMaterial().getId());
        Origin origin = new Origin();
        origin.setId(shose.getOrigin().getId());
        Brand brand = new Brand();
        brand.setId(shose.getBrand().getId());
        Style style = new Style();
        style.setId(shose.getStyle().getId());
        shose.setStyle(style);
        shose.setBrand(brand);
        shose.setOrigin(origin);
        shose.setMaterial(material);
    }
}
